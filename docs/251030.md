###251030 张艺豪


1.doris sql
SELECT
*
FROM order_stats

DELETE FROM window_gmv_top5
WHERE order_date = '2025-10-30'
AND window_start = '2025-10-30 10:00:00'
AND window_end = '2025-10-30 10:10:00'
AND gmv = 1000.50
AND update_time = '2025-10-30 18:42:57';

-- 计算每日GMV环比增长率（使用累积数据的最后一条）
WITH daily_gmv AS (
SELECT
order_date,
MAX(gmv) AS daily_gmv
FROM window_gmv_top5
GROUP BY order_date
),
gmv_with_lag AS (
SELECT
order_date,
daily_gmv,
LAG(daily_gmv, 1, NULL) OVER (ORDER BY order_date) AS prev_day_gmv
FROM daily_gmv
)
SELECT
order_date,
daily_gmv,
prev_day_gmv,
CASE
WHEN prev_day_gmv IS NULL THEN NULL
WHEN prev_day_gmv = 0 THEN NULL
ELSE ROUND((daily_gmv - prev_day_gmv) * 100.0 / prev_day_gmv, 2)
END AS growth_rate_percent
FROM gmv_with_lag
ORDER BY order_date;


--炸裂函数
WITH daily_last_record AS (
SELECT
order_date,
gmv,
top5_product_ids,
window_end,
update_time
FROM (
SELECT
*,
ROW_NUMBER() OVER (PARTITION BY order_date ORDER BY window_end DESC) as rn
FROM window_gmv_top5
) t
WHERE rn = 1  -- 取每天最后一条记录
),
exploded_products AS (
SELECT
order_date,
gmv,
window_end,
update_time,
-- 使用炸裂函数拆分产品ID
SPLIT_PART(top5_product_ids, ',', 1) as product_id_1,
SPLIT_PART(top5_product_ids, ',', 2) as product_id_2,
SPLIT_PART(top5_product_ids, ',', 3) as product_id_3,
SPLIT_PART(top5_product_ids, ',', 4) as product_id_4,
SPLIT_PART(top5_product_ids, ',', 5) as product_id_5
FROM daily_last_record
),
unpivoted_products AS (
SELECT
order_date,
gmv,
window_end,
update_time,
product_id_1 as product_id,
1 as product_rank
FROM exploded_products
UNION ALL
SELECT
order_date,
gmv,
window_end,
update_time,
product_id_2 as product_id,
2 as product_rank
FROM exploded_products
UNION ALL
SELECT
order_date,
gmv,
window_end,
update_time,
product_id_3 as product_id,
3 as product_rank
FROM exploded_products
UNION ALL
SELECT
order_date,
gmv,
window_end,
update_time,
product_id_4 as product_id,
4 as product_rank
FROM exploded_products
UNION ALL
SELECT
order_date,
gmv,
window_end,
update_time,
product_id_5 as product_id,
5 as product_rank
FROM exploded_products
)
SELECT
order_date,
gmv,
window_end,
update_time,
product_id,
product_rank
FROM unpivoted_products
WHERE product_id != '' AND product_id IS NOT NULL
ORDER BY order_date, product_rank;



--连接pgsql
-- 创建PGSQL Catalog（替换为你的实际连接信息）
CREATE CATALOG pgsql_catalog PROPERTIES (
"type" = "jdbc",
"user" = "postgres",           -- 替换为PGSQL用户名
"password" = "pgsql",       -- 替换为PGSQL密码
"jdbc_url" = "jdbc:postgresql://192.168.200.30:5432/spider_db",  -- 替换为PGSQL连接信息
"driver_url" = "https://repo1.maven.org/maven2/org/postgresql/postgresql/42.5.0/postgresql-42.5.0.jar",
"driver_class" = "org.postgresql.Driver"
);